<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shaker - æ™ºèƒ½é¸¡å°¾é…’æ¨èä¸“å®¶</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css?v=1.2">
</head>
<body>
    <!-- æ£®æ—èƒŒæ™¯åŠ¨ç”» -->
    <div class="bg-animation"></div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="main-container">
        
        <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
        <div class="progress-indicator">
            <div class="progress-fill"></div>
        </div>

        <!-- é¦–é¡µ -->
        <section class="hero-section" id="heroSection">
            <div class="hero-content">
                <div class="hero-text">
                    <h1 class="hero-title">
                        <span class="forest-gradient-text">Shaker</span>
                    </h1>
                    <p class="hero-subtitle">æ™ºèƒ½é¸¡å°¾é…’æ¨èä¸“å®¶</p>
                    <p class="hero-description">
                        åŸºäºAIçš„ä¸ªæ€§åŒ–é¸¡å°¾é…’æ¨è<br>
                        ä¸ºæ‚¨çš„æ¯ä¸€ä¸ªåœºæ™¯è°ƒåˆ¶å®Œç¾çš„é‚£ä¸€æ¯
                    </p>
                </div>
                <div class="hero-actions">
                    <button class="cta-button" id="startButton">
                        <span>å¼€å§‹æ¨èä¹‹æ—…</span>
                        <span class="button-icon">ğŸ¸</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- åœºæ™¯é€‰æ‹© -->
        <section class="choice-section" id="sceneSection">
            <div class="section-header">
                <h2 class="section-title">é€‰æ‹©æ‚¨çš„åœºæ™¯</h2>
                <p class="section-subtitle">å‘Šè¯‰æˆ‘ä»¬æ‚¨ç°åœ¨çš„æƒ…å¢ƒ</p>
            </div>
            <div class="scene-grid" id="sceneGrid">
                <!-- åœºæ™¯å¡ç‰‡å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="section-actions">
                <button class="continue-button" id="sceneNextButton" disabled>
                    ç»§ç»­ <span class="arrow">â†’</span>
                </button>
            </div>
        </section>

        <!-- å¿ƒæƒ…é€‰æ‹© -->
        <section class="choice-section" id="moodSection">
            <div class="section-header">
                <h2 class="section-title">æè¿°æ‚¨çš„å¿ƒæƒ…</h2>
                <p class="section-subtitle">å¯ä»¥é€‰æ‹©å¤šä¸ªå¿ƒæƒ…ï¼ˆæœ€å¤š3ä¸ªï¼‰</p>
            </div>
            <div class="mood-grid" id="moodGrid">
                <!-- å¿ƒæƒ…å¡ç‰‡å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="section-actions">
                <button class="continue-button" id="moodNextButton" disabled>
                    ç»§ç»­ <span class="arrow">â†’</span>
                </button>
            </div>
        </section>

        <!-- ææ–™é€‰æ‹© -->
        <section class="choice-section" id="ingredientSection">
            <div class="section-header">
                <h2 class="section-title">é€‰æ‹©å¯ç”¨ææ–™</h2>
                <p class="section-subtitle">å‘Šè¯‰æˆ‘ä»¬æ‚¨æ‰‹å¤´æœ‰ä»€ä¹ˆ</p>
            </div>
            <div class="ingredients-container">
                <div class="ingredient-category">
                    <h3 class="category-title">åŸºé…’</h3>
                    <div class="ingredient-tags" data-category="spirits" id="spiritsContainer">
                        <!-- åŸºé…’é€‰é¡¹å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                <div class="ingredient-category">
                    <h3 class="category-title">è°ƒæ–™</h3>
                    <div class="ingredient-tags" data-category="mixers" id="mixersContainer">
                        <!-- è°ƒæ–™é€‰é¡¹å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                <div class="ingredient-category">
                    <h3 class="category-title">å·¥å…·</h3>
                    <div class="ingredient-tags" data-category="tools" id="toolsContainer">
                        <!-- å·¥å…·é€‰é¡¹å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            <div class="section-actions">
                <button class="continue-button" id="ingredientNextButton">
                    ç»§ç»­ <span class="arrow">â†’</span>
                </button>
            </div>
        </section>

        <!-- åå¥½è®¾ç½® -->
        <section class="choice-section" id="preferenceSection">
            <div class="section-header">
                <h2 class="section-title">è®¾ç½®å£å‘³åå¥½</h2>
                <p class="section-subtitle">è°ƒèŠ‚æ‚¨çš„ä¸ªäººå–œå¥½</p>
            </div>
            <div class="preference-container">
                <div class="preference-item">
                    <label class="preference-label">
                        <span class="label-text">é…’ç²¾åº¦</span>
                        <span class="label-value" id="alcoholLevelValue">ä¸­åº¦</span>
                    </label>
                    <input type="range" class="preference-slider" id="alcoholLevelSlider" 
                           min="0" max="100" value="50" data-preference="alcohol_level">
                    <div class="slider-labels">
                        <span>ä½åº¦</span>
                        <span>ä¸­åº¦</span>
                        <span>é«˜åº¦</span>
                    </div>
                </div>
                
                <div class="preference-item">
                    <label class="preference-label">
                        <span class="label-text">ç”œåº¦</span>
                        <span class="label-value" id="sweetnessValue">å¾®ç”œ</span>
                    </label>
                    <input type="range" class="preference-slider" id="sweetnessSlider" 
                           min="0" max="100" value="50" data-preference="sweetness">
                    <div class="slider-labels">
                        <span>ä¸ç”œ</span>
                        <span>å¾®ç”œ</span>
                        <span>å¾ˆç”œ</span>
                    </div>
                </div>
                
                <div class="preference-item">
                    <label class="preference-label">
                        <span class="label-text">é…¸åº¦</span>
                        <span class="label-value" id="acidityValue">é€‚ä¸­</span>
                    </label>
                    <input type="range" class="preference-slider" id="aciditySlider" 
                           min="0" max="100" value="50" data-preference="acidity">
                    <div class="slider-labels">
                        <span>ä¸é…¸</span>
                        <span>é€‚ä¸­</span>
                        <span>å¾ˆé…¸</span>
                    </div>
                </div>

                <div class="style-selection">
                    <h3 class="style-title">å£æ„Ÿé£æ ¼</h3>
                    <div class="style-grid" id="styleGrid">
                        <!-- é£æ ¼é€‰é¡¹å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            <div class="section-actions">
                <button class="continue-button" id="preferenceNextButton">
                    ç»§ç»­ <span class="arrow">â†’</span>
                </button>
            </div>
        </section>

        <!-- ç‰¹æ®Šè¦æ±‚ -->
        <section class="choice-section" id="requirementSection">
            <div class="section-header">
                <h2 class="section-title">ç‰¹æ®Šè¦æ±‚</h2>
                <p class="section-subtitle">è¿˜æœ‰ä»€ä¹ˆç‰¹åˆ«çš„éœ€æ±‚å—ï¼Ÿï¼ˆå¯é€‰ï¼‰</p>
            </div>
            <div class="requirement-container">
                <textarea class="requirement-input" id="requirementInput" 
                          placeholder="ä¾‹å¦‚ï¼šå¸Œæœ›é¢œå€¼é«˜ä¸€äº›ã€é€‚åˆæ‹ç…§ã€æƒ³è¦åˆ›æ–°å£å‘³..."></textarea>
            </div>
            <div class="section-actions">
                <button class="generate-button" id="generateButton">
                    <span class="button-text">ğŸ§™â€â™‚ï¸ å¼€å§‹è°ƒåˆ¶æ¨è</span>
                </button>
            </div>
        </section>

        <!-- Shakeråˆ†æåŒºåŸŸ -->
        <section class="shaker-analysis-section" id="shakerAnalysisSection">
            <div class="analysis-container">
                <div class="shaker-avatar">ğŸ§™â€â™‚ï¸</div>
                <h2 class="section-title" id="analysisTitle">Shakeræ­£åœ¨ç†è§£æ‚¨çš„éœ€æ±‚...</h2>
                <div class="analysis-content" id="analysisContent">
                    <!-- åˆ†æå†…å®¹å°†åŠ¨æ€æ˜¾ç¤º -->
                </div>
            </div>
        </section>

        <!-- æ¨èç»“æœå±•ç¤ºåŒºåŸŸ -->
        <section class="recommendation-display-section" id="recommendationDisplaySection">
            <div class="recommendation-container">
                <div class="cocktail-cards-grid" id="cocktailCardsGrid">
                    <!-- ä¸‰ä¸ªé¸¡å°¾é…’å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="recommendation-actions">
                    <button class="restart-button" id="restartButton">
                        é‡æ–°å¼€å§‹ <span class="icon">ğŸ”„</span>
                    </button>
                </div>
            </div>
        </section>

    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div class="modal" id="cocktailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle"></h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- è¯¦ç»†å†…å®¹å°†åŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-message" id="loadingMessage">æ­£åœ¨å¤„ç†...</div>
        </div>
    </div>

    <!-- JavaScriptæ¨¡å— -->
    <script type="module">
        // å¯¼å…¥æ¨¡å—
        import { APP_CONFIG, OPTIONS_DATA, INGREDIENTS_DATA, UI_TEXT } from './js/app-config.js';
        import { appState } from './js/app-state.js';
        import { api } from './js/api-client.js';
        import { UIComponent, AnimationUtils, Toast, Modal, Loading, UIUtils } from './js/ui-components.js';

        // å…¨å±€åº”ç”¨å¯¹è±¡
        class ShakerApp {
            constructor() {
                this.currentSection = 0;
                this.sections = APP_CONFIG.SECTIONS;
                this.isTransitioning = false;
                this.init();
            }

            async init() {
                console.log('ğŸš€ Shakeråº”ç”¨åˆå§‹åŒ–...');
                
                // åˆå§‹åŒ–ç»„ä»¶
                this.initializeComponents();
                
                // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                this.setupEventListeners();
                
                // ç”Ÿæˆé€‰é¡¹
                this.generateOptions();
                
                // è®¾ç½®çŠ¶æ€ç›‘å¬
                this.setupStateListeners();
                
                // åˆå§‹åŒ–UI
                this.updateUI();
                
                console.log('âœ… Shakeråº”ç”¨åˆå§‹åŒ–å®Œæˆ');
            }

            initializeComponents() {
                // åˆå§‹åŒ–æ¨¡æ€æ¡†
                this.modal = new Modal('#cocktailModal');
                
                // åˆå§‹åŒ–åŠ è½½ç»„ä»¶
                this.loading = new Loading('#loadingOverlay');
                
                // åˆå§‹åŒ–è¿›åº¦æ¡
                this.updateProgressBar();
            }

            setupEventListeners() {
                // å¼€å§‹æŒ‰é’®
                document.getElementById('startButton')?.addEventListener('click', () => {
                    this.navigateToSection('sceneSection');
                });

                // ç»§ç»­æŒ‰é’®
                document.getElementById('sceneNextButton')?.addEventListener('click', () => {
                    this.navigateToSection('moodSection');
                });

                document.getElementById('moodNextButton')?.addEventListener('click', () => {
                    this.navigateToSection('ingredientSection');
                });

                document.getElementById('ingredientNextButton')?.addEventListener('click', () => {
                    this.navigateToSection('preferenceSection');
                });

                document.getElementById('preferenceNextButton')?.addEventListener('click', () => {
                    this.navigateToSection('requirementSection');
                });

                // ç”Ÿæˆæ¨èæŒ‰é’®
                document.getElementById('generateButton')?.addEventListener('click', () => {
                    this.generateRecommendations();
                });

                // é‡æ–°å¼€å§‹æŒ‰é’®
                document.getElementById('restartButton')?.addEventListener('click', () => {
                    this.restart();
                });

                // æ»šåŠ¨äº‹ä»¶
                window.addEventListener('scroll', UIUtils.throttle(() => {
                    this.updateProgressBar();
                }, 100));

                // é”®ç›˜äº‹ä»¶
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        this.generateRecommendations();
                    }
                });
            }

            generateOptions() {
                // ç”Ÿæˆåœºæ™¯é€‰é¡¹
                this.generateSceneOptions();
                
                // ç”Ÿæˆå¿ƒæƒ…é€‰é¡¹
                this.generateMoodOptions();
                
                // ç”Ÿæˆææ–™é€‰é¡¹
                this.generateIngredientOptions();
                
                // ç”Ÿæˆé£æ ¼é€‰é¡¹
                this.generateStyleOptions();
            }

            generateSceneOptions() {
                const container = document.getElementById('sceneGrid');
                if (!container) return;

                container.innerHTML = OPTIONS_DATA.SCENES.map(scene => `
                    <div class="scene-card" data-value="${scene.value}">
                        <div class="card-icon">${scene.icon}</div>
                        <div class="card-content">
                            <h3 class="card-title">${scene.label}</h3>
                            <p class="card-description">${scene.description}</p>
                        </div>
                    </div>
                `).join('');

                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                container.addEventListener('click', (e) => {
                    this.handleSceneSelection(e);
                });
            }

            generateMoodOptions() {
                const container = document.getElementById('moodGrid');
                if (!container) return;

                container.innerHTML = OPTIONS_DATA.MOODS.map(mood => `
                    <div class="mood-card" data-value="${mood.value}">
                        <div class="card-icon">${mood.icon}</div>
                        <div class="card-content">
                            <h3 class="card-title">${mood.label}</h3>
                            <p class="card-description">${mood.description}</p>
                        </div>
                    </div>
                `).join('');

                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                container.addEventListener('click', (e) => {
                    this.handleMoodSelection(e);
                });
            }

            generateIngredientOptions() {
                // ç”Ÿæˆå„ç±»ææ–™é€‰é¡¹
                Object.entries(INGREDIENTS_DATA).forEach(([category, items]) => {
                    const container = document.getElementById(`${category}Container`);
                    if (!container) return;

                    container.innerHTML = items.map(item => `
                        <div class="ingredient-tag" data-value="${item}">
                            <span class="tag-text">${item}</span>
                        </div>
                    `).join('');

                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    container.addEventListener('click', (e) => {
                        this.handleIngredientSelection(e, category);
                    });
                });
            }

            generateStyleOptions() {
                const container = document.getElementById('styleGrid');
                if (!container) return;

                container.innerHTML = OPTIONS_DATA.STYLES.map(style => `
                    <div class="style-card" data-value="${style.value}">
                        <div class="card-icon">${style.icon}</div>
                        <div class="card-content">
                            <h3 class="card-title">${style.label}</h3>
                            <p class="card-description">${style.description}</p>
                        </div>
                    </div>
                `).join('');

                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                container.addEventListener('click', (e) => {
                    this.handleStyleSelection(e);
                });

                // è®¾ç½®æ»‘å—äº‹ä»¶
                this.setupSliderEvents();
            }

            setupSliderEvents() {
                const sliders = document.querySelectorAll('.preference-slider');
                sliders.forEach(slider => {
                    slider.addEventListener('input', (e) => {
                        this.handlePreferenceChange(e);
                    });
                });
            }

            setupStateListeners() {
                // ç›‘å¬çŠ¶æ€å˜åŒ–æ¥æ›´æ–°UI
                appState.subscribe('userInput.scene', (value) => {
                    this.updateSceneUI(value);
                    this.updateNextButton('sceneNextButton', !!value);
                });

                appState.subscribe('userInput.moods', (value) => {
                    this.updateMoodUI(value);
                    this.updateNextButton('moodNextButton', value && value.length > 0);
                });

                appState.subscribe('userInput.preferences', (value) => {
                    this.updatePreferenceUI(value);
                });
            }

            // äº‹ä»¶å¤„ç†æ–¹æ³•
            handleSceneSelection(e) {
                const card = e.target.closest('.scene-card');
                if (!card) return;

                const scene = card.dataset.value;
                
                // æ›´æ–°çŠ¶æ€
                appState.set('userInput.scene', scene);
                
                // æ›´æ–°UI
                document.querySelectorAll('.scene-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
            }

            handleMoodSelection(e) {
                const card = e.target.closest('.mood-card');
                if (!card) return;

                const mood = card.dataset.value;
                const currentMoods = appState.get('userInput.moods') || [];
                
                if (card.classList.contains('selected')) {
                    // å–æ¶ˆé€‰æ‹©
                    appState.removeFromArray('userInput.moods', mood);
                    card.classList.remove('selected');
                } else {
                    // é€‰æ‹©ï¼ˆæœ€å¤š3ä¸ªï¼‰
                    if (currentMoods.length < APP_CONFIG.MAX_MOODS) {
                        appState.addToArray('userInput.moods', mood);
                        card.classList.add('selected');
                    } else {
                        Toast.warning(`æœ€å¤šåªèƒ½é€‰æ‹©${APP_CONFIG.MAX_MOODS}ä¸ªå¿ƒæƒ…`);
                    }
                }
            }

            handleIngredientSelection(e, category) {
                const tag = e.target.closest('.ingredient-tag');
                if (!tag) return;

                const ingredient = tag.dataset.value;
                const path = `userInput.ingredients.${category}`;
                
                if (tag.classList.contains('selected')) {
                    appState.removeFromArray(path, ingredient);
                    tag.classList.remove('selected');
                } else {
                    appState.addToArray(path, ingredient);
                    tag.classList.add('selected');
                }
            }

            handleStyleSelection(e) {
                const card = e.target.closest('.style-card');
                if (!card) return;

                const style = card.dataset.value;
                
                // æ›´æ–°çŠ¶æ€
                appState.set('userInput.preferences.style', style);
                
                // æ›´æ–°UI
                document.querySelectorAll('.style-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
            }

            handlePreferenceChange(e) {
                const slider = e.target;
                const preference = slider.dataset.preference;
                const value = parseInt(slider.value);
                
                // æ›´æ–°çŠ¶æ€
                appState.set(`userInput.preferences.${preference}`, value);
                
                // æ›´æ–°æ˜¾ç¤º
                this.updatePreferenceValue(preference, value);
            }

            // UIæ›´æ–°æ–¹æ³•
            updateSceneUI(scene) {
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ åœºæ™¯ç›¸å…³çš„UIæ›´æ–°
            }

            updateMoodUI(moods) {
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å¿ƒæƒ…ç›¸å…³çš„UIæ›´æ–°
            }

            updatePreferenceUI(preferences) {
                if (!preferences) return;
                
                Object.entries(preferences).forEach(([key, value]) => {
                    if (typeof value === 'number') {
                        this.updatePreferenceValue(key, value);
                    }
                });
            }

            updatePreferenceValue(preference, value) {
                const valueElement = document.getElementById(`${preference}Value`);
                if (!valueElement) return;

                let text = '';
                switch (preference) {
                    case 'alcohol_level':
                        text = value < 33 ? 'ä½åº¦' : value < 67 ? 'ä¸­åº¦' : 'é«˜åº¦';
                        break;
                    case 'sweetness':
                        text = value < 33 ? 'ä¸ç”œ' : value < 67 ? 'å¾®ç”œ' : 'å¾ˆç”œ';
                        break;
                    case 'acidity':
                        text = value < 33 ? 'ä¸é…¸' : value < 67 ? 'é€‚ä¸­' : 'å¾ˆé…¸';
                        break;
                }
                
                valueElement.textContent = text;
            }

            updateNextButton(buttonId, enabled) {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.disabled = !enabled;
                    button.classList.toggle('enabled', enabled);
                }
            }

            // å¯¼èˆªæ–¹æ³•
            navigateToSection(sectionId) {
                if (this.isTransitioning) return;
                
                this.isTransitioning = true;
                const targetSection = document.getElementById(sectionId);
                
                if (targetSection) {
                    UIUtils.scrollToElement(targetSection, -100);
                    this.currentSection = this.sections.indexOf(sectionId);
                    this.updateProgressBar();
                }
                
                setTimeout(() => {
                    this.isTransitioning = false;
                }, 1000);
            }

            updateProgressBar() {
                const indicator = document.querySelector('.progress-indicator .progress-fill');
                if (!indicator) return;

                const progress = (this.currentSection / (this.sections.length - 1)) * 100;
                indicator.style.width = `${Math.max(0, Math.min(100, progress))}%`;
            }

            // æ¨èç”Ÿæˆ - é›†æˆæ•…äº‹æ€§ä½“éªŒ
            async generateRecommendations() {
                const validation = appState.validateUserInput();
                if (!validation.isValid) {
                    Toast.error(`è¯·å®Œæˆå¿…å¡«é¡¹ï¼š${validation.missing.join(', ')}`);
                    return;
                }

                // è·å–ç‰¹æ®Šè¦æ±‚
                const requirementInput = document.getElementById('requirementInput');
                if (requirementInput) {
                    appState.set('userInput.special_requirements', requirementInput.value.trim());
                }

                const requestData = appState.getRecommendationData();
                
                try {
                    // æ˜¾ç¤ºåˆ†æåŒºåŸŸ
                    this.showAnalysisSection();
                    
                    // å¯åŠ¨æ•…äº‹æ€§åˆ†æä½“éªŒ
                    await this.startStoryAnalysisExperience(requestData);
                    
                    // ç„¶åå¯åŠ¨AIæ¨è
                    await api.getStreamRecommendation(requestData, {
                        onData: (data) => this.handleStreamData(data),
                        onError: (error) => this.handleStreamError(error),
                        onComplete: () => this.handleStreamComplete()
                    });

                } catch (error) {
                    console.error('âŒ æ¨èç”Ÿæˆå¤±è´¥:', error);
                    Toast.error('æ¨èæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•');
                }
            }

            // å¯åŠ¨æ•…äº‹æ€§åˆ†æä½“éªŒ
            async startStoryAnalysisExperience(userInput) {
                const analysisContainer = document.getElementById('analysisContent');
                if (!analysisContainer) return;

                try {
                    // åŠ¨æ€å¯¼å…¥æ•…äº‹æ€§åˆ†ææ¨¡å—
                    const { reviewCards } = await import('./js/review-card-generator.js');
                    const { thoughtBubbles } = await import('./js/thought-bubble-generator.js');
                    
                    // æ¸…ç©ºåˆ†æå®¹å™¨
                    analysisContainer.innerHTML = '';
                    
                    // åˆ›å»ºShakerå¤´åƒå®¹å™¨ï¼ˆç”¨äºæ€è€ƒæ°”æ³¡ï¼‰
                    const shakerContainer = document.createElement('div');
                    shakerContainer.className = 'shaker-container';
                    shakerContainer.innerHTML = `
                        <div class="shaker-avatar-wrapper">
                            <div class="shaker-avatar">ğŸ§™â€â™‚ï¸</div>
                            <div class="thought-bubbles-container"></div>
                        </div>
                    `;
                    analysisContainer.appendChild(shakerContainer);
                    
                    // åˆ›å»ºè¯„è®ºå¡ç‰‡å®¹å™¨
                    const reviewContainer = document.createElement('div');
                    reviewContainer.className = 'review-cards-container';
                    analysisContainer.appendChild(reviewContainer);
                    
                    // å¯åŠ¨æ•…äº‹æ€§åˆ†æåºåˆ—
                    await reviewCards.generateReviewSequence(
                        userInput, 
                        reviewContainer,
                        (phase, current, total) => {
                            // æ¯ä¸ªé˜¶æ®µå®Œæˆæ—¶æ˜¾ç¤ºæ€è€ƒæ°”æ³¡
                            this.showThoughtBubblesForPhase(phase, userInput);
                        }
                    );
                    
                    console.log('âœ… æ•…äº‹æ€§åˆ†æä½“éªŒå®Œæˆ');
                    
                } catch (error) {
                    console.error('âŒ æ•…äº‹æ€§åˆ†æå¤±è´¥:', error);
                    // é™çº§åˆ°åŸæœ‰çš„ç®€å•åˆ†æ
                    this.fallbackToSimpleAnalysis(analysisContainer, userInput);
                }
            }

            // ä¸ºæŒ‡å®šé˜¶æ®µæ˜¾ç¤ºæ€è€ƒæ°”æ³¡
            async showThoughtBubblesForPhase(phase, userInput) {
                const bubbleContainer = document.querySelector('.thought-bubbles-container');
                if (!bubbleContainer) return;

                try {
                    const { thoughtBubbles } = await import('./js/thought-bubble-generator.js');
                    
                    // ç”Ÿæˆè¯¥é˜¶æ®µçš„æ€è€ƒæ°”æ³¡åºåˆ—
                    const sequence = thoughtBubbles.generateThoughtSequence(phase, 2000, userInput);
                    
                    // æ˜¾ç¤ºæ€è€ƒæ°”æ³¡
                    await thoughtBubbles.showThoughtSequence(bubbleContainer, sequence);
                    
                } catch (error) {
                    console.warn('âš ï¸ æ€è€ƒæ°”æ³¡æ˜¾ç¤ºå¤±è´¥:', error);
                }
            }

            // é™çº§åˆ°ç®€å•åˆ†æ
            fallbackToSimpleAnalysis(container, userInput) {
                container.innerHTML = `
                    <div class="simple-analysis">
                        <div class="shaker-avatar">ğŸ§™â€â™‚ï¸</div>
                        <p class="analysis-text">æ­£åœ¨ä¸ºä½ åˆ†æéœ€æ±‚å¹¶è°ƒåˆ¶ä¸“å±é¸¡å°¾é…’...</p>
                    </div>
                `;
            }

            showAnalysisSection() {
                const section = document.getElementById('shakerAnalysisSection');
                if (section) {
                    section.style.display = 'block';
                    UIUtils.scrollToElement(section, -50);
                }
            }

            handleStreamData(data) {
                switch (data.type) {
                    case 'connected':
                        console.log('ğŸ”— æµå¼è¿æ¥æˆåŠŸ');
                        break;
                        
                    case 'segmented_analysis':
                        this.handleSegmentedAnalysis(data);
                        break;
                        
                    case 'phase_transition':
                        this.handlePhaseTransition(data);
                        break;
                        
                    case 'recommendation':
                        this.handleRecommendation(data);
                        break;
                        
                    case 'complete':
                        this.handleStreamComplete();
                        break;
                        
                    case 'error':
                        this.handleStreamError(new Error(data.message));
                        break;
                }
            }

            async handleSegmentedAnalysis(data) {
                if (!data.segments) return;

                const analysisContent = document.getElementById('analysisContent');
                const analysisTitle = document.getElementById('analysisTitle');

                for (let i = 0; i < data.segments.length; i++) {
                    const segment = data.segments[i];
                    
                    // æ›´æ–°æ ‡é¢˜
                    if (analysisTitle) {
                        analysisTitle.textContent = segment.title;
                    }
                    
                    // æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºå†…å®¹
                    if (analysisContent) {
                        await AnimationUtils.typeWriter(analysisContent, segment.content);
                        await new Promise(resolve => setTimeout(resolve, 2000)); // åœé¡¿2ç§’
                    }
                }
            }

            handlePhaseTransition(data) {
                // æ˜¾ç¤ºæ¨èç»“æœåŒºåŸŸ
                const recommendationSection = document.getElementById('recommendationDisplaySection');
                if (recommendationSection) {
                    recommendationSection.style.display = 'block';
                    UIUtils.scrollToElement(recommendationSection, -50);
                }
            }

            handleRecommendation(data) {
                console.log('ğŸ¸ æ”¶åˆ°æ¨èæ•°æ®:', data);
                
                if (data.content && data.content.recommendations) {
                    const recommendation = data.content.recommendations[0];
                    const index = data.index || 0;
                    
                    // å­˜å‚¨æ¨èæ•°æ®ï¼Œç­‰å¾…å±•ç¤º
                    if (!this.pendingRecommendations) {
                        this.pendingRecommendations = [];
                    }
                    this.pendingRecommendations[index] = recommendation;
                    
                    console.log(`ğŸ“¦ å­˜å‚¨ç¬¬${index + 1}ä¸ªæ¨è:`, recommendation.name?.chinese);
                }
            }

            // å±•ç¤ºæ¨èå¡ç‰‡
            async displayRecommendationCards() {
                console.log('ğŸ¨ å¼€å§‹å±•ç¤ºæ¨èå¡ç‰‡');
                
                const cardsGrid = document.getElementById('cocktailCardsGrid');
                if (!cardsGrid) {
                    console.error('âŒ æ‰¾ä¸åˆ°å¡ç‰‡å®¹å™¨');
                    return;
                }
                
                // æ¸…ç©ºå®¹å™¨
                cardsGrid.innerHTML = '';
                
                // é€ä¸ªåˆ›å»ºå’Œå±•ç¤ºå¡ç‰‡
                for (let i = 0; i < Math.min(this.pendingRecommendations.length, 3); i++) {
                    const recommendation = this.pendingRecommendations[i];
                    if (recommendation) {
                        const card = this.createCocktailCard(recommendation, i);
                        cardsGrid.appendChild(card);
                        
                        // å»¶è¿Ÿæ˜¾ç¤ºæ¯ä¸ªå¡ç‰‡ï¼Œè¥é€ é€ä¸ªå‡ºç°çš„æ•ˆæœ
                        setTimeout(() => {
                            this.animateCardAppearance(card, i);
                        }, i * 300);
                    }
                }
                
                console.log('âœ… æ¨èå¡ç‰‡å±•ç¤ºå®Œæˆ');
            }
            
            // åˆ›å»ºé¸¡å°¾é…’å¡ç‰‡
            createCocktailCard(recommendation, index) {
                const card = document.createElement('div');
                card.className = 'cocktail-card';
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                
                // è§£ææ¨èæ•°æ®
                const name = recommendation.name?.chinese || recommendation.chinese || 'ç¥ç§˜é¸¡å°¾é…’';
                const englishName = recommendation.name?.english || recommendation.english || 'Mystery Cocktail';
                const reason = recommendation.reason || 'ä¸ºæ‚¨ç²¾å¿ƒè°ƒåˆ¶';
                const alcoholContent = recommendation.alcohol_content || 'é€‚ä¸­(çº¦15%)';
                const prepTime = recommendation.prep_time || '5åˆ†é’Ÿ';
                const difficulty = recommendation.recipe?.difficulty || 'ç®€å•';
                const tasteProfile = recommendation.taste_profile || 'å£æ„Ÿå¹³è¡¡ï¼Œå±‚æ¬¡ä¸°å¯Œ';
                
                // å¤„ç†ææ–™åˆ—è¡¨
                const ingredients = recommendation.recipe?.ingredients || recommendation.ingredients || [];
                const ingredientTags = ingredients.slice(0, 4).map(ing => {
                    if (typeof ing === 'string') return ing;
                    return `${ing.name || ing} ${ing.amount || ''}`.trim();
                }).filter(Boolean);
                
                card.innerHTML = `
                    <div class="alcohol-badge">${alcoholContent}</div>
                    
                    <div class="cocktail-title" data-text="${name}"></div>
                    <div class="cocktail-subtitle" data-text="${englishName}"></div>
                    
                    <div class="recommendation-reason">
                        <span class="reason-icon">âœ“</span>
                        <div class="reason-text" data-text="æ¨èç†ç”±ï¼š${reason}"></div>
                    </div>
                    
                    <div class="ingredients-section">
                        <div class="ingredients-header">
                            <span class="ingredients-icon">âœ“</span>
                            <span class="ingredients-label">ä¸»è¦ææ–™ï¼š</span>
                        </div>
                        <div class="ingredients-tags">
                            ${ingredientTags.map(ingredient => 
                                `<span class="ingredient-tag">${ingredient}</span>`
                            ).join('')}
                        </div>
                    </div>
                    
                    <div class="taste-section">
                        <div class="taste-header">
                            <span class="taste-icon">ğŸŒ¸</span>
                            <span class="taste-label">å£æ„Ÿç‰¹ç‚¹ï¼š</span>
                        </div>
                        <div class="taste-description" data-text="${tasteProfile}"></div>
                    </div>
                    
                    <div class="card-footer">
                        <div class="card-meta">
                            <div class="meta-item">
                                <span class="meta-icon">â±</span>
                                <span>${prepTime}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-icon">ğŸ“Š</span>
                                <span>${difficulty}</span>
                            </div>
                        </div>
                        <button class="view-details-btn" data-recommendation='${JSON.stringify(recommendation)}'>
                            æŸ¥çœ‹è¯¦æƒ…
                        </button>
                    </div>
                `;
                
                // æ·»åŠ è¯¦æƒ…æŒ‰é’®äº‹ä»¶
                const detailsBtn = card.querySelector('.view-details-btn');
                detailsBtn?.addEventListener('click', () => {
                    this.showCocktailDetails(recommendation);
                });
                
                return card;
            }
            
            // å¡ç‰‡å‡ºç°åŠ¨ç”»
            async animateCardAppearance(card, index) {
                // å¡ç‰‡æ·¡å…¥
                card.style.transition = 'all 0.6s ease-out';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
                
                // ç­‰å¾…å¡ç‰‡åŠ¨ç”»å®Œæˆ
                await new Promise(resolve => setTimeout(resolve, 600));
                
                // å¼€å§‹æ‰“å­—æœºæ•ˆæœ
                await this.startTypingEffect(card);
            }
            
            // æ‰“å­—æœºæ•ˆæœ
            async startTypingEffect(card) {
                const elementsToType = card.querySelectorAll('[data-text]');
                
                for (const element of elementsToType) {
                    const text = element.getAttribute('data-text');
                    element.removeAttribute('data-text');
                    element.textContent = '';
                    
                    // æ‰“å­—æœºæ•ˆæœ
                    await this.typeText(element, text, 30); // 30ms per character
                    
                    // æ¯ä¸ªå…ƒç´ ä¹‹é—´ç¨ä½œåœé¡¿
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }
            
            // æ‰“å­—æœºæ–‡æœ¬æ•ˆæœ
            async typeText(element, text, speed = 50) {
                return new Promise(resolve => {
                    let i = 0;
                    const timer = setInterval(() => {
                        element.textContent = text.slice(0, i + 1);
                        i++;
                        
                        if (i >= text.length) {
                            clearInterval(timer);
                            resolve();
                        }
                    }, speed);
                });
            }
            
            // æ˜¾ç¤ºé¸¡å°¾é…’è¯¦æƒ…
            showCocktailDetails(recommendation) {
                if (!this.modal) return;

                const content = this.generateCocktailDetailsHTML(recommendation);
                this.modal.setContent(content).open();
                
                // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜
                const title = document.getElementById('modalTitle');
                if (title) {
                    title.textContent = recommendation.name?.chinese || 'é¸¡å°¾é…’è¯¦æƒ…';
                }
            }

            generateCocktailDetailsHTML(recommendation) {
                return `
                    <div class="cocktail-details">
                        <div class="cocktail-info">
                            <h3>${recommendation.name?.chinese || 'é¸¡å°¾é…’'}</h3>
                            <p class="english-name">${recommendation.name?.english || ''}</p>
                            <p class="reason">${recommendation.reason || ''}</p>
                        </div>
                        
                        <div class="recipe-section">
                            <h4>ğŸ“ é…æ–¹</h4>
                            <ul class="ingredients-list">
                                ${recommendation.recipe?.ingredients?.map(ing => 
                                    `<li>${typeof ing === 'string' ? ing : `${ing.name}: ${ing.amount}`}</li>`
                                ).join('') || ''}
                            </ul>
                        </div>
                        
                        <div class="instructions-section">
                            <h4>ğŸ§ª åˆ¶ä½œæ­¥éª¤</h4>
                            <ol class="instructions-list">
                                ${recommendation.instructions?.map(step => 
                                    `<li>${step}</li>`
                                ).join('') || ''}
                            </ol>
                        </div>
                        
                        <div class="meta-info">
                            <div class="meta-item">
                                <span class="label">åˆ¶ä½œæ—¶é—´:</span>
                                <span class="value">${recommendation.prep_time || 'æœªçŸ¥'}</span>
                            </div>
                            <div class="meta-item">
                                <span class="label">é…’ç²¾åº¦:</span>
                                <span class="value">${recommendation.alcohol_content || 'æœªçŸ¥'}</span>
                            </div>
                            <div class="meta-item">
                                <span class="label">å£æ„Ÿ:</span>
                                <span class="value">${recommendation.taste_profile || 'æœªçŸ¥'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            handleStreamError(error) {
                console.error('âŒ æµå¼æ¨èé”™è¯¯:', error);
                Toast.error('æ¨èè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ' + error.message);
            }

            handleStreamComplete() {
                console.log('âœ… æµå¼æ¨èå®Œæˆ');
                
                // å¼€å§‹å±•ç¤ºæ¨èå¡ç‰‡
                if (this.pendingRecommendations && this.pendingRecommendations.length > 0) {
                    this.displayRecommendationCards();
                } else {
                    console.warn('âš ï¸ æ²¡æœ‰æ¨èæ•°æ®å¯å±•ç¤º');
                    Toast.error('æ¨èæ•°æ®è·å–å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }

            restart() {
                // é‡ç½®çŠ¶æ€
                appState.reset();
                
                // æ¸…ç†æ¨èæ•°æ®
                this.pendingRecommendations = [];
                
                // é‡ç½®UI
                this.currentSection = 0;
                this.updateProgressBar();
                
                // æ¸…é™¤é€‰æ‹©çŠ¶æ€
                document.querySelectorAll('.selected').forEach(el => {
                    el.classList.remove('selected');
                });
                
                // é‡ç½®æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.continue-button').forEach(btn => {
                    btn.disabled = true;
                    btn.classList.remove('enabled');
                });
                
                // éšè—åˆ†æå’Œæ¨èåŒºåŸŸ
                document.getElementById('shakerAnalysisSection').style.display = 'none';
                document.getElementById('recommendationDisplaySection').style.display = 'none';
                
                // æ¸…ç©ºå†…å®¹
                document.getElementById('requirementInput').value = '';
                document.getElementById('cocktailCardsGrid').innerHTML = '';
                
                // æ»šåŠ¨åˆ°é¡¶éƒ¨
                UIUtils.scrollToElement(document.getElementById('heroSection'));
                
                Toast.info('å·²é‡æ–°å¼€å§‹');
            }

            updateUI() {
                // åˆå§‹åŒ–æ—¶çš„UIè®¾ç½®
                this.updateProgressBar();
                
                // éšè—éåˆå§‹åŒºåŸŸ
                document.getElementById('shakerAnalysisSection').style.display = 'none';
                document.getElementById('recommendationDisplaySection').style.display = 'none';
            }
        }

        // å¯åŠ¨åº”ç”¨
        const app = new ShakerApp();
        
        // æš´éœ²åˆ°å…¨å±€ä¾›è°ƒè¯•
        if (typeof window !== 'undefined') {
            window.shakerApp = app;
        }
    </script>
</body>
</html>
